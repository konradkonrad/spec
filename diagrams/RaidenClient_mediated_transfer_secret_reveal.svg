<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1245" height="1253" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[participant Initiator
participant Mediator1
participant Mediator2
participant Target
participant SecretRegistryContract

Initiator -> Mediator1: LockedTransfer\n(HTL, BP,\ninitiator_address,\ntarget_address)
Note over Initiator, Mediator1: Delivered + Processed messages\nleft out for brevity
Mediator1 -> Mediator2: LockedTransfer \n (HTL, BP,\ninitiator_address,\ntarget_address)
Mediator2 -> Target: LockedTransfer \n (HTL, BP,\ninitiator_address,\ntarget_address)
Target -> Initiator: SecretRequest \n (amount,\nsecrethash,\nsignature)
Initiator -> Target: RevealSecret \n (secret, signature)
Target -> Mediator2: RevealSecret \n (secret, signature)

Note over Mediator2, Target: Bad behaviour\nMediator2 does not send the BP\nto Target


Note over Target: waits until lock \n is about to expire
Note over Target: CHOICE \n lose the transfer \n or go ON CHAIN
Target -> SecretRegistryContract: registerSecret(secret)
Note over Initiator, SecretRegistryContract: Secret can be used by all nodes to UNLOCK the transfer after settling the channels \n SecretRegistry.getSecretRevealBlockHeight(secrethash)
Mediator2 --> Mediator1: RevealSecret \n (secret, signature)
Mediator1 --> Mediator2: Unlock BP_M1
Mediator1 --> Initiator: RevealSecret \n (secret, signature)
Initiator --> Mediator1: Unlock BP_I
]]></source><desc></desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"></g><g class="actor"><rect x="10" y="20" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="20" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="20">Initiator</tspan></text></g><g class="actor"><rect x="10" y="1194.6000328063965" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="20" y="1219.6000328063965" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="20">Initiator</tspan></text></g><line x1="65" x2="65" y1="59" y2="1194.6000328063965" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="300" y="20" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="310" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="310">Mediator1</tspan></text></g><g class="actor"><rect x="300" y="1194.6000328063965" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="310" y="1219.6000328063965" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="310">Mediator1</tspan></text></g><line x1="355" x2="355" y1="59" y2="1194.6000328063965" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="510" y="20" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="520" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="520">Mediator2</tspan></text></g><g class="actor"><rect x="510" y="1194.6000328063965" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="520" y="1219.6000328063965" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="520">Mediator2</tspan></text></g><line x1="565" x2="565" y1="59" y2="1194.6000328063965" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="815" y="20" width="80" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="825" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="825">Target</tspan></text></g><g class="actor"><rect x="815" y="1194.6000328063965" width="80" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="825" y="1219.6000328063965" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="825">Target</tspan></text></g><line x1="855" x2="855" y1="59" y2="1194.6000328063965" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="975" y="20" width="240" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="985" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="985">SecretRegistryContract</tspan></text></g><g class="actor"><rect x="975" y="1194.6000328063965" width="240" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="985" y="1219.6000328063965" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="985">SecretRegistryContract</tspan></text></g><line x1="1095" x2="1095" y1="59" y2="1194.6000328063965" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="signal"><text x="120" y="60.69999694824219" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="120">LockedTransfer</tspan><tspan dy="1.2em" x="120">(HTL, BP,</tspan><tspan dy="1.2em" x="120">initiator_address,</tspan><tspan dy="1.2em" x="120">target_address)</tspan></text><line x1="65" x2="355" y1="155.60000610351562" y2="155.60000610351562" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="note"><rect x="55" y="175.60000610351562" width="310" height="48.20000076293945" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="60" y="195.60000610351562" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="60">Delivered + Processed messages</tspan><tspan dy="1.2em" x="60">left out for brevity</tspan></text></g><g class="signal"><text x="370" y="225.50000381469727" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="370">LockedTransfer</tspan><tspan dy="1.2em" x="370">(HTL, BP,</tspan><tspan dy="1.2em" x="370">initiator_address,</tspan><tspan dy="1.2em" x="370">target_address)</tspan></text><line x1="355" x2="565" y1="320.4000129699707" y2="320.4000129699707" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="620" y="322.1000099182129" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="620">LockedTransfer</tspan><tspan dy="1.2em" x="620">(HTL, BP,</tspan><tspan dy="1.2em" x="620">initiator_address,</tspan><tspan dy="1.2em" x="620">target_address)</tspan></text><line x1="565" x2="855" y1="417.0000190734863" y2="417.0000190734863" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="395" y="418.7000160217285" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="395">SecretRequest</tspan><tspan dy="1.2em" x="395">(amount,</tspan><tspan dy="1.2em" x="395">secrethash,</tspan><tspan dy="1.2em" x="395">signature)</tspan></text><line x1="855" x2="65" y1="513.600025177002" y2="513.600025177002" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="365" y="534.5000247955322" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="365">RevealSecret</tspan><tspan dy="1.2em" x="365">(secret, signature)</tspan></text><line x1="65" x2="855" y1="571.8000259399414" y2="571.8000259399414" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="615" y="592.7000255584717" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="615">RevealSecret</tspan><tspan dy="1.2em" x="615">(secret, signature)</tspan></text><line x1="855" x2="565" y1="630.0000267028809" y2="630.0000267028809" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="note"><rect x="555" y="650.0000267028809" width="310" height="67.4000015258789" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="560" y="670.0000267028809" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="560">Bad behaviour</tspan><tspan dy="1.2em" x="560">Mediator2 does not send the BP</tspan><tspan dy="1.2em" x="560">to Target</tspan></text></g><g class="note"><rect x="760" y="737.4000282287598" width="190" height="48.20000076293945" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="765" y="757.4000282287598" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="765">waits until lock</tspan><tspan dy="1.2em" x="765">is about to expire</tspan></text></g><g class="note"><rect x="765" y="805.6000289916992" width="180" height="67.4000015258789" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="770" y="825.6000289916992" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="770">CHOICE</tspan><tspan dy="1.2em" x="770">lose the transfer</tspan><tspan dy="1.2em" x="770">or go ON CHAIN</tspan></text></g><g class="signal"><text x="865" y="903.5000305175781" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="865">registerSecret(secret)</tspan></text><line x1="855" x2="1095" y1="912.0000305175781" y2="912.0000305175781" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="note"><rect x="55" y="932.0000305175781" width="1050" height="48.20000076293945" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="60" y="952.0000305175781" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="60">Secret can be used by all nodes to UNLOCK the transfer after settling the channels</tspan><tspan dy="1.2em" x="60">SecretRegistry.getSecretRevealBlockHeight(secrethash)</tspan></text></g><g class="signal"><text x="365" y="1001.1000308990479" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="365">RevealSecret</tspan><tspan dy="1.2em" x="365">(secret, signature)</tspan></text><line x1="565" x2="355" y1="1038.400032043457" y2="1038.400032043457" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="400" y="1068.900032043457" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="400">Unlock BP_M1</tspan></text><line x1="355" x2="565" y1="1077.400032043457" y2="1077.400032043457" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="115" y="1098.3000316619873" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="115">RevealSecret</tspan><tspan dy="1.2em" x="115">(secret, signature)</tspan></text><line x1="355" x2="65" y1="1135.6000328063965" y2="1135.6000328063965" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="155" y="1166.1000328063965" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="155">Unlock BP_I</tspan></text><line x1="65" x2="355" y1="1174.6000328063965" y2="1174.6000328063965" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g></svg>